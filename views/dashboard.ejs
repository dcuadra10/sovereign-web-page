<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Dashboard - Sovereign Empire</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; min-height: 100vh; background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%); color: #fff; overflow-x: hidden; }
        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 20px 40px; background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.1); position: sticky; top: 0; z-index: 1000; }
        .nav-brand { font-size: 1.3rem; font-weight: 700; text-decoration: none; color: white; display: flex; align-items: center; gap: 10px; }
        .nav-links { display: flex; gap: 20px; align-items: center; }
        .btn { padding: 8px 16px; border-radius: 6px; text-decoration: none; font-weight: 500; border: none; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; }
        .btn-danger { background: rgba(220,38,38,0.8); color: white; }
        .btn-admin { background: linear-gradient(135deg, #ff9966, #ff5e62); color:white; }

        .container { max-width: 1400px; margin: 0 auto; padding: 40px; display: grid; grid-template-columns: 350px 1fr; gap: 30px; }
        .sidebar { display: flex; flex-direction: column; gap: 20px; }
        .card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 25px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
        .profile-card { text-align: center; }
        .avatar { width: 100px; height: 100px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.2); margin-bottom: 15px; object-fit: cover; }
        .user-name { font-size: 1.4rem; font-weight: 700; margin-bottom: 5px; }
        .user-id { font-size: 0.9rem; opacity: 0.6; margin-bottom: 20px; font-family: monospace; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; margin-bottom: 15px; }
        .status-linked { background: rgba(74, 222, 128, 0.2); color: #4ade80; border: 1px solid rgba(74, 222, 128, 0.4); }
        .status-unlinked { background: rgba(248, 113, 113, 0.2); color: #f87171; border: 1px solid rgba(248, 113, 113, 0.4); }

        .form-group { margin-bottom: 15px; text-align: left; }
        .form-control { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; }
        
        .main-content { display: flex; flex-direction: column; gap: 30px; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-box { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 10px; text-align: center; }
        .stat-val { font-size: 1.5rem; font-weight: 700; display: block; margin-bottom: 5px; }
        .stat-lbl { font-size: 0.9rem; opacity: 0.7; }
        
        .progress-bar-container { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 20px; margin-top: 20px; }
        .bar-bg { background: rgba(0,0,0,0.3); height: 12px; border-radius: 6px; overflow: hidden; margin: 10px 0; }
        .bar-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 1s ease; }
        .bar-success { background: linear-gradient(90deg, #11998e, #38ef7d); }
        .bar-warning { background: linear-gradient(90deg, #f5576c, #f093fb); }
        
        .announcements-box { margin-bottom: 20px; }
        .announcement { background: rgba(255,255,255,0.03); border-left: 4px solid #a78bfa; padding: 15px; margin-bottom: 10px; border-radius: 4px; }
        .announcement h4 { margin-bottom: 5px; color: #a78bfa; font-size: 1.1rem; }
        .announcement p { font-size: 0.95rem; line-height: 1.5; opacity: 0.9; }
        .date-tag { font-size: 0.75rem; opacity: 0.5; display: block; margin-top: 8px; }

        .info-box { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 10px; line-height: 1.6; }

        /* Toast Styles */
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 15px 25px; border-radius: 10px; color: white; font-weight: 500; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; gap: 10px; animation: slideDown 0.5s ease forwards, fadeOut 0.5s ease 3.5s forwards; max-width: 90%; }
        .toast-error { background: rgba(220, 38, 38, 0.9); border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(10px); }
        .toast-success { background: rgba(22, 163, 74, 0.9); border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(10px); }
        @keyframes slideDown { from { top: -50px; opacity: 0; } to { top: 20px; opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; visibility: hidden; } }

        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/" class="nav-brand"> Sovereign Empire</a>
        <div class="nav-links">
            <% if (statsVisible) { %>
                <a href="/stats" class="btn btn-secondary">Leaderboard</a>
            <% } %>
            <% if (isAdmin) { %><a href="/admin" class="btn btn-admin">Admin Panel</a><% } %>
            <a href="/logout" class="btn btn-danger">Logout</a>
        </div>
    </nav>

    <div class="container">
        <!-- SIDEBAR: PROFILE & LINKING -->
        <div class="sidebar">
            <div class="card profile-card">
                <img src="<%= user.avatar ? (user.avatar.startsWith('http') ? user.avatar : `https://cdn.discordapp.com/avatars/${user.discordId}/${user.avatar}.png`) : 'https://cdn.discordapp.com/embed/avatars/0.png' %>" class="avatar">
                <h2 class="user-name"><%= user.username %></h2>
                <div class="user-id">ID: <%= user.discordId || 'Email User' %></div>
                
                <% if (user.governor_id) { %>
                     <div class="status-badge status-linked">Linked: <%= user.governor_id %></div>
                <% } else { %>
                     <div class="status-badge status-unlinked">Not Linked</div>
                     <form action="/link-account" method="POST" style="margin-top:15px;">
                        <div class="form-group">
                            <input type="number" name="governorId" class="form-control" placeholder="Enter Governor ID" required>
                        </div>
                        <button class="btn btn-secondary" style="width:100%; background: linear-gradient(135deg, #667eea, #764ba2);">Link Account</button>
                     </form>
                <% } %>
            </div>
            
            <% if (!statsVisible) { %>
            <div class="card" style="border: 1px solid #f87171; background: rgba(220, 38, 38, 0.1);">
                <h3 style="color:#f87171; margin-bottom:10px;"> Stats Hidden</h3>
                <p style="font-size:0.9rem; opacity:0.8;">The public leaderboard and personal stats are currently unavailable. Check back later.</p>
            </div>
            <% } %>

            <!-- CONTACT LEADERS BUTTON -->
            <div class="card">
                <button onclick="document.getElementById('contactList').style.display = document.getElementById('contactList').style.display === 'none' ? 'flex' : 'none'" class="btn btn-secondary" style="width:100%; display:flex; justify-content:center; align-items:center; gap:8px;">
                     Contact Leadership
                </button>
                <div id="contactList" style="display:none; flex-direction:column; gap:12px; margin-top:15px; border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;">
                    <% if(typeof adminList !== 'undefined' && adminList.length > 0) { 
                       adminList.forEach(admin => { %>
                        <div style="display:flex; align-items:center; gap:12px; background:rgba(255,255,255,0.02); padding:8px; border-radius:6px;">
                            <img src="<%= admin.avatar ? (admin.avatar.startsWith('http') ? admin.avatar : `https://cdn.discordapp.com/avatars/${admin.discord_id}/${admin.avatar}.png`) : 'https://cdn.discordapp.com/embed/avatars/0.png' %>" style="width:35px; height:35px; border-radius:50%; object-fit:cover;">
                            <div style="flex:1;">
                               <div style="font-weight:600; font-size:0.9rem;"><%= admin.username || 'Unknown User' %></div>
                               <div style="font-size:0.75rem; opacity:0.6;"><%= admin.note || 'Admin' %></div>
                            </div>
                        </div>
                    <% }); } else { %>
                        <div style="opacity:0.6; font-size:0.9rem; text-align:center;">No public contacts listed.</div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- PROJECT INFO & ANNOUNCEMENTS -->
            <% if (projectInfo || (announcements && announcements.length > 0)) { %>
            <div class="card">
                <h2 style="margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;"> News & Information</h2>
                
                <% if (announcements && announcements.length > 0) { %>
                    <div class="announcements-box">
                        <% announcements.forEach(a => { %>
                            <div class="announcement">
                                <h4><%- a.title %></h4>
                                <div><%- a.content %></div>
                                <span class="date-tag"><%= new Date(a.created_at).toLocaleDateString() %></span>
                            </div>
                        <% }) %>
                    </div>
                <% } %>
                
                <% if (projectInfo) { %>
                    <div class="info-box">
                        <h3 style="margin-bottom:10px; color:#a78bfa;">ℹ Project Information</h3>
                        <div style="line-height:1.6;"><%- projectInfo %></div>
                    </div>
                <% } %>
            </div>
            <% } %>

            <!-- PERSONAL STATS (IF LINKED AND VISIBLE) -->
            <% 
               let myStats = null;
               if (user.governor_id && stats) {
                   myStats = stats.find(s => s.governor_id === user.governor_id);
               }
            %>

            <!-- AQUI APLICO EL CAMBIO: Solo mostrar si myStats existe Y statsVisible es true -->
            <% if (myStats && statsVisible) { %>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h2>Your Statistics <span style="font-size:0.9rem; opacity:0.6; font-weight:400;">(Season: <%= currentKvK || 'N/A' %>)</span></h2>
                        <span class="status-badge" style="<%= myStats.isCompliant ? 'background:rgba(74,222,128,0.2); color:#4ade80' : 'background:rgba(248,113,113,0.2); color:#f87171' %>">
                            Status: <%= myStats.isCompliant ? 'COMPLIANT' : 'RISK' %>
                        </span>
                    </div>

                     <!-- Formatter Script -->
                    <script>
                        function fmt(n) {
                            if (!n && n !== 0) return '0'; n = Number(n);
                            if (n >= 1000000000) return (n / 1000000000).toFixed(2) + 'B';
                            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
                            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
                            return n.toLocaleString();
                        }
                    </script>

                    <div class="stat-grid">
                        <div class="stat-box"><span class="stat-val"><script>document.write(fmt(<%= myStats.highest_power %>))</script></span><span class="stat-lbl">Current Power</span></div>
                         <div class="stat-box"><span class="stat-val"><script>document.write(fmt(<%= myStats.killsGained %>))</script></span><span class="stat-lbl">KP Gained (Season)</span></div>
                         <div class="stat-box"><span class="stat-val"><script>document.write(fmt(<%= myStats.deadsGained %>))</script></span><span class="stat-lbl">Deaths (Season)</span></div>
                         <div class="stat-box"><span class="stat-val"><%= myStats.tier ? myStats.tier.name : 'Unknown' %></span><span class="stat-lbl">Current Tier</span></div>
                    </div>

                    <div style="margin-top:15px; text-align:right; font-size:0.8rem; opacity:0.6;">
                        Comparing against Season Start Date: <%= seasonStart || 'Unknown' %>
                    </div>

                    <div class="progress-bar-container">
                        <h3>Season Progress</h3>
                        <div style="margin-top:15px;">
                            <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
                                <span>Kill Points Goal (<script>document.write(fmt(<%= myStats.killReq %>))</script>)</span>
                                <span><%= myStats.killProgress %>%</span>
                            </div>
                            <div class="bar-bg"><div class="bar-fill <%= myStats.killProgress >= 100 ? 'bar-success' : '' %>" style="width: <%= Math.min(myStats.killProgress, 100) %>%"></div></div>
                        </div>

                        <div style="margin-top:15px;">
                            <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
                                <span>Deaths Goal (<script>document.write(fmt(<%= myStats.deathReq %>))</script>)</span>
                                <span><%= myStats.deathProgress %>%</span>
                            </div>
                            <div class="bar-bg"><div class="bar-fill <%= myStats.deathProgress >= 100 ? 'bar-success' : (myStats.deathProgress < 50 ? 'bar-warning' : '') %>" style="width: <%= Math.min(myStats.deathProgress, 100) %>%"></div></div>
                        </div>
                    </div>
                </div>
            <% } else if (user.governor_id && statsVisible) { %>
                <div class="card" style="text-align:center; padding:40px;">
                    <h3>Processing Stats...</h3>
                    <p style="opacity:0.7;">Your ID is linked, but we haven't found your stats in the latest scan yet. Please check back later or contact an admin if you recently migrated.</p>
                </div>
            <% } else if (statsVisible) { %>
                <div class="card" style="text-align:center; padding:50px;">
                    <img src="https://img.icons8.com/fluency/96/link.png" style="opacity:0.8; margin-bottom:20px;">
                    <h2>Link Your Account</h2>
                    <p style="opacity:0.7; max-width:400px; margin:0 auto;">Please enter your Governor ID in the sidebar to view your personalized season statistics and progress.</p>
                </div>
            <% } %>
            
            <% if (statsVisible) { %>
            <a href="/stats" class="btn btn-secondary" style="text-align:center; padding:15px; margin-top:10px;">View Full Season Leaderboard</a>
            <% } %>
        </div>
    </div>

    <!-- Toast Script -->
    <script>
        const params = new URLSearchParams(window.location.search);
        function showToast(msg, type = 'success') {
            const t = document.createElement('div'); t.className = `toast toast-${type}`;
            t.innerHTML = (type==='error'?' ':' ') + msg;
            document.body.appendChild(t); setTimeout(() => t.remove(), 4000);
        }
        if (params.get('success')) showToast(decodeURIComponent(params.get('success')), 'success');
        if (params.get('error')) showToast(decodeURIComponent(params.get('error')), 'error');
        if (params.get('success') || params.get('error')) window.history.replaceState({}, document.title, window.location.pathname);
    </script>
</body>
</html>
