<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel - Sovereign Empire</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Inter',sans-serif; }
        body { background:#0f172a; color:#f8fafc; padding:20px; }
        header { display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; padding-bottom:20px; border-bottom:1px solid #334155; }
        h1 { color:#a78bfa; font-size:1.8rem; }
        h2 { font-size:1.2rem; margin-bottom:15px; color:#ddd; border-left:4px solid #a78bfa; padding-left:10px; }
        .grid-container { display:grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap:20px; }
        .card { background:#1e293b; padding:20px; border-radius:12px; border:1px solid #334155; box-shadow:0 10px 15px -3px rgba(0,0,0,0.1); }
        .form-control { width:100%; padding:10px; margin-bottom:10px; background:#0f172a; border:1px solid #475569; border-radius:6px; color:white; }
        .btn { padding:10px 20px; border-radius:6px; border:none; cursor:pointer; font-weight:600; text-decoration:none; display:inline-block; }
        .btn-primary { background:#7c3aed; color:white; } .btn-primary:hover { background:#6d28d9; }
        .btn-danger { background:#ef4444; color:white; } .btn-secondary { background:#475569; color:white; }
        table { width:100%; border-collapse:collapse; margin-top:10px; font-size:0.9rem; }
        th, td { text-align:left; padding:8px; border-bottom:1px solid #334155; }
        th { color:#94a3b8; }
        .success-msg { color:#4ade80; margin-bottom:10px; }
        
        /* Toast Styles */
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 15px 25px; border-radius: 10px; color: white; font-weight: 500; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; gap: 10px; animation: slideDown 0.5s ease forwards, fadeOut 0.5s ease 3.5s forwards; max-width: 90%; }
        .toast-success { background: rgba(22, 163, 74, 0.9); } .toast-error { background: rgba(220, 38, 38, 0.9); }
        @keyframes slideDown { from { top: -50px; opacity: 0; } to { top: 20px; opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; visibility: hidden; } }
    </style>
</head>
<body>
    <header>
        <h1>Admin Control Panel</h1>
        <div>
            <a href="/admin/forms" class="btn btn-secondary" style="margin-right:10px;"> Manage Forms & Roles</a>
            <a href="/dashboard" class="btn btn-secondary">Return to Dashboard</a>
        </div>
    </header>

    <div class="grid-container">
        <!-- Announcements Management -->
        <div class="card">
            <h2> Manage Announcements</h2>
            <form action="/admin/announcement" method="POST" style="margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:20px;">
                <input type="hidden" name="action" value="create">
                <input type="text" name="title" placeholder="Announcement Title" class="form-control" required style="font-weight:bold;">
                <textarea name="content" rows="4" placeholder="Content (Markdown supported: **bold**, *italic*, [link](url))" class="form-control" required></textarea>
                
                <label style="display:block; margin:10px 0 5px; font-size:0.9rem;">Target Audience (Notifications will be sent)</label>
                <select name="roleId" class="form-control">
                    <option value="all">All Members</option>
                    <% if (locals.roles) { roles.forEach(r => { %>
                        <option value="<%= r.id %>"><%= r.name %></option>
                    <% }) } %>
                </select>

                <button class="btn btn-primary" style="margin-top:10px;">Post Announcement</button>
            </form>

            <table style="max-height:200px; overflow-y:auto; display:block;">
                <thead><tr><th>Date</th><th>Title</th><th>Audience</th><th>Action</th></tr></thead>
                <tbody>
                    <% announcements.forEach(a => { %>
                    <tr>
                        <td><%= new Date(a.created_at).toLocaleDateString() %></td>
                        <td><%= a.title %></td>
                        <td><%= a.target_role_name || 'All' %></td>
                        <td>
                            <form action="/admin/announcement" method="POST" onsubmit="return confirm('Delete?')">
                                <input type="hidden" name="action" value="delete"> <input type="hidden" name="id" value="<%= a.id %>">
                                <button class="btn btn-danger" style="padding:2px 8px; font-size:0.8rem;">X</button>
                            </form>
                        </td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>

        <!-- Project Info -->
        <div class="card">
            <h2>ℹ Project Info Text</h2>
            <form action="/admin/project-info" method="POST">
                <textarea name="content" rows="6" class="form-control" placeholder="Markdown supported..."><%= projectInfo || '' %></textarea>
                <button class="btn btn-primary">Update Info</button>
            </form>
        </div>

        <!-- Excel Upload -->
        <div class="card">
            <h2> Upload Stats (Excel)</h2>
            <p style="font-size:0.8rem; color:#94a3b8; margin-bottom:15px;">Filename must contain dates: 'Kingdom#-StartDate-EndDate.xlsx'</p>
            
            <div style="margin-bottom:15px;">
                <label>Update Existing Stats</label>
                <form id="uploadUpdateForm" style="display:flex; gap:10px;">
                    <input type="file" name="file" accept=".xlsx" class="form-control" required>
                    <button type="button" onclick="uploadFile('update')" class="btn btn-primary">Update</button>
                </form>
            </div>
            
            <div style="border-top:1px solid #334155; padding-top:15px;">
                <label style="color:#ef4444;"> New Scan (Resets Current Data)</label>
                <form id="uploadCreationForm" style="display:flex; gap:10px;">
                    <input type="file" name="file" accept=".xlsx" class="form-control" required>
                    <button type="button" onclick="uploadFile('creation')" class="btn btn-danger">New Scan</button>
                </form>
            </div>
            <div id="progress" style="height:4px; background:#334155; margin-top:10px; border-radius:2px; overflow:hidden;"><div id="bar" style="width:0%; height:100%; background:#22c55e; transition:width 0.3s;"></div></div>
        </div>

        <!-- Config -->
        <div class="card">
            <h2> Configuration</h2>
            <form action="/admin/config" method="POST">
                <label>Discord Guild ID</label>
                <input type="text" name="guildId" value="<%= guildId %>" class="form-control">
                <label>Verified Role ID</label>
                <input type="text" name="roleId" value="<%= roleId %>" class="form-control">
                <button class="btn btn-secondary">Save Config</button>
            </form>
            
            <div style="margin-top:20px; border-top:1px solid #334155; padding-top:15px;">
                <h3>KvK Season</h3>
                <form action="/admin/kvk" method="POST" style="display:flex; gap:10px; margin-bottom:10px;">
                    <input type="text" name="kvkName" value="<%= currentKvK %>" class="form-control" placeholder="e.g. Season 1">
                    <button class="btn btn-primary">Set Name</button>
                </form>
                 <form action="/admin/kvk" method="POST" onsubmit="return confirm('WARNING: This will backup current data and WIPE all stats for a new season start. Confirm?')">
                    <input type="hidden" name="action" value="reset">
                    <input type="hidden" name="kvkName" value="New Season"> <!-- Placeholder -->
                    <button class="btn btn-danger" style="width:100%;"> End Season & Reset Stats </button>
                </form>
            </div>

            <div style="margin-top:20px; border-top:1px solid #334155; padding-top:15px;">
                <h3>Public Stats Visibility</h3>
                <form action="/admin/toggle-stats" method="POST">
                    <button class="btn" style="width:100%; background: <%= statsVisible ? '#22c55e' : '#ef4444' %>">
                        <%= statsVisible ? 'Stats are VISIBLE (Click to Hide)' : 'Stats are HIDDEN (Click to Show)' %>
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Backups -->
        <div class="card" style="grid-column: span 2;">
            <h2> Backups</h2>
            <table>
                <thead><tr><th>Name</th><th>Season</th><th>Date</th><th>Filename</th><th>Size</th><th>Action</th></tr></thead>
                <tbody>
                    <% backups.forEach(b => { %>
                    <tr>
                        <td><%= b.name %></td>
                        <td><%= b.kvk_season %></td>
                        <td><%= new Date(b.created_at).toLocaleString() %></td>
                        <td><%= b.filename %></td>
                        <td><%= b.count %></td>
                        <td style="display:flex; gap:5px;">
                            <a href="/admin/backup/download/<%= b.id %>" class="btn btn-primary btn-sm" target="_blank" style="padding:5px;"></a>
                            <form action="/admin/backup/delete" method="POST" onsubmit="return confirm('Delete this backup permanently?')">
                                <input type="hidden" name="id" value="<%= b.id %>">
                                <button class="btn btn-danger btn-sm" style="padding:5px;"></button>
                            </form>
                        </td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        function showToast(msg, type = 'success') {
            const t = document.createElement('div');
            t.className = `toast toast-${type}`;
            t.innerHTML = '<span>' + (type==='success'?' ':' ') + msg + '</span>';
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 4000);
        }

        const params = new URLSearchParams(window.location.search);
        if (params.get('ok')) showToast('Action successful!', 'success');
        if (params.get('err')) showToast(decodeURIComponent(params.get('err')), 'error');

        function uploadFile(type) {
            const form = document.getElementById(type === 'update' ? 'uploadUpdateForm' : 'uploadCreationForm');
            const fileInput = form.querySelector('input[type="file"]');
            if (!fileInput.files.length) return alert('Select a file');
            
            const fd = new FormData();
            fd.append('file', fileInput.files[0]);
            
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/admin/upload/' + type);
            
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const pct = (e.loaded / e.total) * 100;
                    document.getElementById('bar').style.width = pct + '%';
                }
            };
            
            xhr.onload = () => {
                if (xhr.status === 409) {
                     const resp = JSON.parse(xhr.responseText);
                     if (confirm(resp.warning + "\n\nDo you want to force proceed?")) {
                         // Retry with force
                         const xhr2 = new XMLHttpRequest();
                         xhr2.open('POST', '/admin/upload/' + type + '?force=true');
                         xhr2.onload = () => { if(xhr2.status===200) { showToast('Forced Upload Success', 'success'); setTimeout(()=>location.reload(), 2000); } else showToast('Error: ' + xhr2.responseText, 'error'); };
                         xhr2.send(fd);
                     } else {
                         document.getElementById('bar').style.width = '0%';
                     }
                } else if (xhr.status===200) {
                     showToast('Upload Successful! Page reloading...', 'success');
                     setTimeout(() => location.reload(), 2000);
                } else {
                     showToast('Error: ' + xhr.responseText, 'error');
                     document.getElementById('bar').style.width = '0%';
                }
            };
            xhr.send(fd);
        }
    </script>
</body>
</html>
