<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Sovereign Empire</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; min-height: 100vh; background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%); color: #fff; }
    .navbar { display: flex; justify-content: space-between; align-items: center; padding: 20px 40px; background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.1); }
    .nav-brand { display: flex; align-items: center; gap: 12px; font-size: 1.3rem; font-weight: 700; text-decoration: none; color: white; }
    .nav-links { display: flex; gap: 20px; }
    .btn { padding: 8px 16px; border-radius: 6px; text-decoration: none; font-weight: 500; border: none; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
    .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
    .btn-danger { background: linear-gradient(135deg, #f5576c, #f093fb); color: white; }
    .btn-secondary { background: rgba(255,255,255,0.1); color: white; }
    .btn-success { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; }
    
    .btn.active-btn { background: #fff; color: #302b63; box-shadow: 0 0 15px rgba(255,255,255,0.5); }
    
    .container { max-width: 1400px; margin: 0 auto; padding: 40px; }
    .section { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 25px; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.1); }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .form-group { margin-bottom: 15px; }
    .form-control { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; }
    .tier-card { background: rgba(255,255,255,0.03); border-radius: 8px; padding: 15px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
    
    .report-chunk { margin-bottom: 20px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; }
    textarea.report-area { width: 100%; height: 150px; padding: 10px; background: rgba(0,0,0,0.3); color: #fff; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; font-family: monospace; resize: vertical; margin-bottom: 5px; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.9rem; }
    th { opacity: 0.7; font-weight: 500; }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="/" class="nav-brand"> Sovereign Empire Admin</a>
    <div class="nav-links">
        <a href="/dashboard" class="btn btn-secondary">Dashboard</a>
        <a href="/logout" class="btn btn-secondary">Logout</a>
    </div>
  </nav>
  
  <div class="container">
    <div class="grid-2">
        <!-- GLOBAL CONFIG -->
        <div class="section">
            <h2> System Config</h2>
            <form action="/admin/config" method="POST" style="margin-bottom: 20px;">
                <div class="form-group">
                    <label>Discord Server ID (Guild ID)</label>
                    <input type="text" name="guildId" class="form-control" value="<%= guildId || '' %>" required placeholder="e.g. 123456789012345678">
                </div>
                <button class="btn btn-primary">Save Config</button>
            </form>
            <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin: 20px 0;">
            <h3> KvK Season Management</h3>
            <form action="/admin/kvk" method="POST" onsubmit="return confirmAction(this)">
                <div class="form-group">
                    <label>Current KvK Name</label>
                    <input type="text" name="kvkName" class="form-control" value="<%= currentKvK %>" placeholder="e.g. KvK 1">
                </div>
                <div style="display:flex; gap:10px;">
                    <button type="button" class="btn btn-primary" onclick="this.form.action.value='save'; this.form.submit()">Update Name</button>
                    <button type="submit" name="action" value="reset" class="btn btn-danger" onclick="return confirm('WARNING: This will DELETE ALL STATS to start a new season (A Backup will be created). Continue?')">Reset All Stats (New KvK)</button>
                </div>
            </form>
        </div>

        <!-- ADMIN MANAGEMENT -->
        <div class="section">
            <h2> Manage Admins</h2>
            <form action="/admin/manage-admins" method="POST" style="margin-bottom: 20px; display: flex; gap: 10px;">
                <input type="text" name="discordId" class="form-control" placeholder="Discord User ID" required>
                <input type="text" name="note" class="form-control" placeholder="Note (e.g. Leader)">
                <button type="submit" name="action" value="add" class="btn btn-success">Add</button>
            </form>
            <div style="max-height: 200px; overflow-y: auto;">
                <% admins.forEach(a => { %>
                    <div class="tier-card">
                        <div><strong><%= a.note || 'Admin' %></strong><br><span style="font-size: 0.8rem; opacity: 0.7;"><%= a.discord_id %></span></div>
                        <% if (a.discord_id !== user.discordId) { %>
                            <form action="/admin/manage-admins" method="POST"><input type="hidden" name="discordId" value="<%= a.discord_id %>"><button type="submit" name="action" value="remove" class="btn btn-danger btn-sm">Remove</button></form>
                        <% } else { %><span style="font-size: 0.8rem; color: #4ade80;">You</span><% } %>
                    </div>
                <% }) %>
            </div>
        </div>
    </div>

    <!-- BACKUPS -->
    <div class="section">
        <h2> Backups / History</h2>
        <div style="max-height: 250px; overflow-y: auto;">
            <table>
                <thead><tr><th>Name</th><th>Date</th><th>KvK / File</th><th>Size</th><th>Action</th></tr></thead>
                <tbody>
                    <% if (backups.length === 0) { %><tr><td colspan="5" style="text-align:center; opacity:0.5;">No backups found</td></tr><% } %>
                    <% backups.forEach(b => { %>
                        <tr>
                            <td><%= b.name %></td>
                            <td><%= new Date(b.created_at).toLocaleDateString() %></td>
                            <td><%= b.kvk_season %> <span style="font-size:0.7em; opacity:0.6;"><%= b.filename %></span></td>
                            <td><%= b.count %> records</td>
                            <td>
                                <form action="/admin/backup/delete" method="POST" onsubmit="return confirm('Delete this backup permanently?')">
                                    <input type="hidden" name="id" value="<%= b.id %>">
                                    <button class="btn btn-danger btn-sm"></button>
                                </form>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </div>

    <!-- TIERS & UPLOAD -->
    <div class="grid-2">
        <div class="section">
            <h2> Tier Requirements</h2>
            <form action="/admin/tier" method="POST">
                <input type="hidden" name="id" id="tierId">
                <div class="form-group"><input type="text" name="name" class="form-control" placeholder="Tier Name" id="tierName" required></div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <input type="number" name="minPower" class="form-control" placeholder="Min Power" id="tierMin" required>
                    <input type="number" name="maxPower" class="form-control" placeholder="Max Power" id="tierMax" required>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                    <input type="number" step="0.01" name="killMultiplier" class="form-control" placeholder="Kill Mult (1.0)" id="tierKill" required>
                    <input type="number" step="0.0001" name="deathMultiplier" class="form-control" placeholder="Death Mult (0.05)" id="tierDeath" required>
                </div>
                <button class="btn btn-success" style="margin-top:10px;">Save Tier</button>
            </form>
            <div style="margin-top:20px; max-height:300px; overflow-y:auto;">
                <% tiers.forEach(t => { %>
                    <div class="tier-card">
                        <div><strong><%= t.name %></strong> <span style="font-size:0.8rem">(<%= Number(t.min_power)/1000000 %>M - <%= Number(t.max_power)/1000000 %>M)</span><br><span style="font-size:0.8rem">Kill: <%= t.kill_multiplier %>x | Death: <%= t.death_multiplier %>x</span></div>
                        <button class="btn btn-secondary btn-sm" onclick="editTier(<%= JSON.stringify(t) %>)">Edit</button>
                    </div>
                <% }) %>
            </div>
        </div>

        <div class="section">
            <h2> Upload Stats</h2>
            <form id="uploadForm">
                <input type="file" id="fileInput" class="form-control" accept=".xlsx,.xls">
                <div class="progress-bar-bg" style="height:5px; background:rgba(255,255,255,0.1); margin:10px 0;"><div id="bar" style="height:100%; width:0%; background:#4ade80;"></div></div>
                <div style="display:flex; gap:10px;">
                    <button type="button" class="btn btn-danger" onclick="upload('creation')">New List (Wipe Old)</button>
                    <button type="button" class="btn btn-primary" onclick="upload('update')">Update Progress</button>
                </div>
            </form>
            <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin: 25px 0;">
            <h2> One-Click Reports</h2>
            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom: 20px;">
                <button class="btn btn-secondary report-btn" onclick="generateReport('non-compliant', this)">Copy Non-Compliant List</button>
                <div style="display:flex; align-items:center;">
                    <input type="number" id="topLimit" value="10" style="width:60px; padding:8px; border-radius:6px 0 0 6px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white;">
                    <button class="btn btn-secondary report-btn" style="border-radius:0 6px 6px 0;" onclick="generateReport('top', this)">Copy Top Contributors</button>
                </div>
            </div>
            <div id="reportContainer"><textarea class="report-area" placeholder="Report output..." readonly></textarea></div>
        </div>
    </div>
  </div>

  <script>
    function editTier(t) {
        document.getElementById('tierId').value = t.id;
        document.getElementById('tierName').value = t.name;
        document.getElementById('tierMin').value = t.min_power;
        document.getElementById('tierMax').value = t.max_power;
        document.getElementById('tierKill').value = t.kill_multiplier;
        document.getElementById('tierDeath').value = t.death_multiplier;
    }
    
    function upload(type, force = false) {
        const file = document.getElementById('fileInput').files[0];
        if(!file) return alert('Select file');
        if(type==='creation' && !confirm('Delete existing stats? This will create a backup first.')) return;
        
        const fd = new FormData(); fd.append('file', file);
        const xhr = new XMLHttpRequest();
        xhr.upload.onprogress = e => document.getElementById('bar').style.width = (e.loaded/e.total*100) + '%';
        xhr.onload = () => {
            if (xhr.status === 409) {
                const resp = JSON.parse(xhr.responseText);
                if (confirm(resp.warning + "\n\nDo you want to proceed anyway?")) {
                    upload(type, true); // Retry with force
                }
            } else if (xhr.status===200) {
                 alert('Success'); location.reload();
            } else {
                 alert('Error: ' + xhr.responseText);
            }
        };
        xhr.open('POST', '/admin/upload/'+type + (force ? '?force=true' : '')); xhr.send(fd);
    }
    
    async function generateReport(type, btn) {
        document.querySelectorAll('.report-btn').forEach(b => b.classList.remove('active-btn')); btn.classList.add('active-btn');
        const limit = document.getElementById('topLimit').value;
        const url = type === 'top' ? '/api/reports/top?limit=' + limit : '/api/reports/non-compliant';
        try {
            const res = await fetch(url); const list = await res.json();
            const container = document.getElementById('reportContainer'); container.innerHTML = '';
            if (list.length === 0) { container.innerHTML = '<p style="opacity:0.6">No records found.</p>'; return; }
            const MAX_CHARS = 1900; let currentChunk = ''; let chunks = [];
            list.forEach(line => { if ((currentChunk.length + line.length + 1) > MAX_CHARS) { chunks.push(currentChunk); currentChunk = ''; } currentChunk += line + '\n'; });
            if (currentChunk) chunks.push(currentChunk);
            chunks.forEach((chunk, index) => {
                const div = document.createElement('div'); div.className = 'report-chunk';
                div.innerHTML = `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Part ${index + 1} / ${chunks.length}</span><button class="btn btn-success btn-sm" onclick="copyText(this)">Copy</button></div><textarea class="report-area" readonly>${chunk}</textarea>`;
                container.appendChild(div);
            });
        } catch(e) { alert('Error generating report'); }
    }
    
    function copyText(btn) { const area = btn.parentElement.nextElementSibling; area.select(); document.execCommand('copy'); const original = btn.innerText; btn.innerText = 'Copied!'; setTimeout(() => btn.innerText = original, 1000); }
  </script>
</body>
</html>
