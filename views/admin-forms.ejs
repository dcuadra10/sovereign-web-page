<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Forms & Roles - Sovereign Empire</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Inter', sans-serif; }
        body { background:#0f172a; color:#fff; padding:40px; }
        h1, h2, h3 { color:#f5f5f5; margin-bottom:20px; }
        .back-link { color:#a78bfa; text-decoration:none; margin-bottom:30px; display:inline-block; }
        
        .tabs { display:flex; gap:10px; margin-bottom:30px; border-bottom:1px solid #334155; padding-bottom:10px; }
        .tab { background:none; border:none; color:#94a3b8; font-size:1.1rem; cursor:pointer; padding:10px 20px; font-weight:600; }
        .tab.active { color:#a78bfa; border-bottom:2px solid #a78bfa; }
        .tab-content { display:none; }
        .tab-content.active { display:block; }

        .card { background:#1e293b; padding:25px; border-radius:12px; margin-bottom:20px; border:1px solid #334155; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1); }
        .btn { padding:10px 20px; border-radius:8px; border:none; color:white; cursor:pointer; font-weight:600; text-decoration:none; display:inline-flex; align-items:center; gap:5px; }
        .btn-primary { background:#7c3aed; }
        .btn-danger { background:#ef4444; }
        .btn-success { background:#22c55e; }
        .btn-secondary { background:#475569; }
        
        table { width:100%; border-collapse:collapse; margin-top:15px; }
        th, td { text-align:left; padding:12px; border-bottom:1px solid #334155; }
        th { color:#94a3b8; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.05em; }
        
        input, select, textarea { width:100%; padding:10px; background:#0f172a; border:1px solid #334155; border-radius:6px; color:white; margin-bottom:15px; }
        label { display:block; margin-bottom:5px; color:#cbd5e1; font-size:0.9rem; }
        .role-badge { display:inline-block; padding:4px 10px; border-radius:20px; font-size:0.85rem; font-weight:600; color:black; }
        .field-row { display:flex; gap:10px; align-items:center; background:#0f172a; padding:10px; border-radius:6px; margin-bottom:10px; border:1px solid #334155; }
        .remove-field { background:#ef4444; color:white; width:30px; height:30px; border-radius:50%; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; }
    </style>
</head>
<body>
    <a href="/dashboard" class="back-link">&larr; Back to Dashboard</a>
    <a href="/admin" class="back-link" style="margin-left:20px;">&larr; Admin Panel</a>
    
    <h1>Forms & Roles Management</h1>

    <div class="tabs">
        <button class="tab active" onclick="showTab('forms')">Form Builder</button>
        <button class="tab" onclick="showTab('roles')">Role Management</button>
    </div>

    <!-- FORMS TAB -->
    <div id="forms" class="tab-content active">
        <div class="card" style="background: rgba(124, 58, 237, 0.1); border: 1px solid rgba(124, 58, 237, 0.3);">
            <h3> Onboarding Configuration</h3>
            <p style="margin-bottom:15px; opacity:0.8;">Select a form that new users MUST complete before accessing the dashboard.</p>
            <form action="/admin/onboarding" method="POST" style="display:flex; gap:10px;">
                <select name="formId" style="margin:0;">
                    <option value="">-- None (Disable Onboarding) --</option>
                    <% forms.forEach(f => { %>
                        <option value="<%= f.id %>" <%= (typeof onboardingId !== 'undefined' && onboardingId == f.id) ? 'selected' : '' %>><%= f.title %></option>
                    <% }) %>
                </select>
                <button class="btn btn-primary">Save Setting</button>
            </form>
        </div>

        <div class="card">
            <h2>Create New Form</h2>
            <form action="/admin/forms/create" method="POST" onsubmit="prepareSchema()">
                <label>Form Title</label>
                <input type="text" name="title" required placeholder="e.g. KvK 1 Application">
                <label>Description</label>
                <textarea name="description" rows="3" placeholder="Explain the purpose..."></textarea>
                <label>Assign Role on Completion (Optional)</label>
                <select name="assignRoleId">
                    <option value="">-- No Role Assigned --</option>
                    <% if(locals.roles) { roles.forEach(r => { %>
                        <option value="<%= r.id %>"><%= r.name %></option>
                    <% }) } %>
                </select>
                <h3>Form Fields</h3>
                <div id="fields-container"></div>
                <button type="button" onclick="addField()" class="btn btn-secondary" style="margin-bottom:20px;">+ Add Field</button>
                <input type="hidden" name="schema" id="schema-input">
                <br>
                <button type="submit" class="btn btn-primary">Create Form</button>
            </form>
        </div>

        <div class="card">
            <h2>Active Forms</h2>
            <table>
                <thead><tr><th>Title</th><th>Role Award</th><th>Status</th><th>Responses</th><th>Actions</th></tr></thead>
                <tbody>
                    <% forms.forEach(f => { %>
                    <tr>
                        <td><%= f.title %> <%= (typeof onboardingId !== 'undefined' && onboardingId == f.id) ? ' (Onboarding)' : '' %></td>
                        <td>
                            <% if (f.assign_role_name) { %> <span class="role-badge" style="background:#ddd"><%= f.assign_role_name %></span> <% } else { %> - <% } %>
                        </td>
                        <td>
                            <form action="/admin/forms/toggle" method="POST" style="display:inline;">
                                <input type="hidden" name="id" value="<%= f.id %>">
                                <button class="btn btn-sm" style="background:none; border:1px solid <%= f.is_active ? '#22c55e' : '#ef4444' %>; color:<%= f.is_active ? '#22c55e' : '#ef4444' %>; padding:2px 8px;">
                                    <%= f.is_active ? 'Active' : 'Closed' %>
                                </button>
                            </form>
                        </td>
                        <td>
                            <a href="/admin/forms/<%= f.id %>/responses" class="btn btn-sm btn-primary" style="padding:4px 10px;">View Responses</a>
                        </td>
                        <td>
                            <form action="/admin/forms/delete" method="POST" onsubmit="return confirm('Delete form?')" style="display:inline;">
                                <input type="hidden" name="id" value="<%= f.id %>">
                                <button class="btn btn-sm btn-danger" style="padding:4px 8px;"></button>
                            </form>
                        </td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ROLES TAB -->
    <div id="roles" class="tab-content">
        <div class="card">
            <h2>Create New Role</h2>
            <form action="/admin/roles/create" method="POST">
                <div style="display:flex; gap:15px;">
                    <div style="flex:1;">
                        <label>Role Name</label>
                        <input type="text" name="name" required placeholder="e.g. Officer, Verified..">
                    </div>
                    <div style="width:100px;">
                        <label>Color</label>
                        <input type="color" name="color" value="#ffffff" style="height:45px;">
                    </div>
                </div>
                <button class="btn btn-success">Add Role</button>
            </form>
        </div>

        <div class="card">
            <h2>Existing Roles</h2>
            <div style="display:flex; flex-wrap:wrap; gap:10px;">
                <% if(locals.roles) { roles.forEach(r => { %>
                    <div style="background:#1e293b; padding:10px 15px; border:1px solid #334155; border-radius:8px; display:flex; align-items:center; gap:10px;">
                        <div style="width:20px; height:20px; border-radius:50%; background:<%= r.color %>;"></div>
                        <span style="font-weight:600;"><%= r.name %></span>
                        <form action="/admin/roles/delete" method="POST" onsubmit="return confirm('Delete role?')" style="margin:0;">
                            <input type="hidden" name="id" value="<%= r.id %>">
                            <button style="background:none; border:none; cursor:pointer; color:#ef4444; font-size:1.1rem;">&times;</button>
                        </form>
                    </div>
                <% }) } else { %>
                    <p style="opacity:0.5;">No roles defined yet.</p>
                <% } %>
            </div>
        </div>
    </div>

    <script>
        const availableRoles = <%- JSON.stringify(locals.roles || []) %>;

        function showTab(id) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab[onclick="showTab('${id}')"]`).classList.add('active');
            document.getElementById(id).classList.add('active');
        }

        let fields = [];
        
        function renderFields() {
            const c = document.getElementById('fields-container');
            c.innerHTML = '';
            fields.forEach((f, idx) => {
                let roleMapperHtml = '';
                
                // If Select Type, show Role Mapper
                if (f.type === 'select') {
                    const opts = f.options ? f.options.split(',').map(s=>s.trim()).filter(s=>s) : [];
                    if (opts.length > 0) {
                        roleMapperHtml = `<div style="margin-top:10px; padding:10px; background:rgba(0,0,0,0.2); border-radius:6px;">
                            <small style="display:block; margin-bottom:5px; color:#a78bfa;"> Assign Roles to Options (Optional)</small>
                            ${opts.map(opt => `
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                    <span style="font-size:0.9rem;">${opt}</span>
                                    <select onchange="updateRoleMap(${idx}, '${opt}', this.value)" style="width:150px; padding:4px; margin:0;">
                                        <option value="">No Role</option>
                                        ${availableRoles.map(r => `
                                            <option value="${r.id}" ${f.roleMap && f.roleMap[opt] == r.id ? 'selected' : ''}>${r.name}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            `).join('')}
                        </div>`;
                    }
                }

                c.innerHTML += `
                    <div style="background:#0f172a; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #334155;">
                        <div style="display:flex; gap:10px; align-items:flex-start;">
                            <div style="flex:1; display:grid; gap:10px;">
                                <div style="display:flex; gap:10px;">
                                    <select onchange="updateField(${idx}, 'type', this.value)" style="width:140px; margin:0;">
                                        <option value="text" ${f.type==='text'?'selected':''}>Short Text</option>
                                        <option value="textarea" ${f.type==='textarea'?'selected':''}>Paragraph</option>
                                        <option value="file" ${f.type==='file'?'selected':''}>File Upload</option>
                                        <option value="select" ${f.type==='select'?'selected':''}>Dropdown/Cards</option>
                                    </select>
                                    <input type="text" value="${f.label}" oninput="updateField(${idx}, 'label', this.value)" placeholder="Question Label (e.g. Choose Class)" style="margin:0; flex:1;">
                                </div>
                                ${f.type === 'select' ? `<input type="text" value="${f.options||''}" oninput="updateField(${idx}, 'options', this.value)" placeholder="Options separated by commas (e.g. Infantry, Cavalry, Archer)" style="margin:0;">` : ''}
                            </div>
                            <button type="button" class="remove-field" onclick="removeField(${idx})" style="height:40px;">&times;</button>
                        </div>
                        ${roleMapperHtml}
                    </div>
                `;
            });
        }

        function addField() {
            fields.push({ type: 'text', label: '', required: true, options: '', roleMap: {} });
            renderFields();
        }

        function removeField(idx) {
            fields.splice(idx, 1);
            renderFields();
        }

        function updateField(idx, key, val) {
            fields[idx][key] = val;
            if (key === 'options') {
                // If options change, we could reset map, but keeping is safer for now
            }
            if (key === 'type' || key === 'options') renderFields(); 
        }

        function updateRoleMap(idx, optionText, roleId) {
            if (!fields[idx].roleMap) fields[idx].roleMap = {};
            if (roleId) {
                fields[idx].roleMap[optionText] = roleId;
            } else {
                delete fields[idx].roleMap[optionText];
            }
        }

        function prepareSchema() {
            document.getElementById('schema-input').value = JSON.stringify(fields);
        }
    </script>
</body>
</html>
